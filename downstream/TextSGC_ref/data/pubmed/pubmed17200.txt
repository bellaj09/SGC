Laboratory studies of analogical reasoning have shown that subjects are mostly influenced by superficial similarity in the retrieval of source analogs. However real-world investigations have demonstrated that people generate analogies using deep structural features. We conducted three experiments to determine why laboratory and real-world studies have yielded different results. In the first two experiments we used a "production paradigm" in which subjects were asked to generate sources for a given target. Results show that the majority of the analogies that were generated displayed low levels of superficial similarity with the target problem. Moreover most of the analogies were based on complex underlying structures. The third experiment used a "reception paradigm" methodology. The subjects had to retrieve predetermined sources instead of generate their own. In this case retrieval was largely constrained by surface similarity. We conclude that people can use structural relations when given an appropriate task and that this ability has been underestimated in previous research on analogy. How analogies are generated: the roles of structural and superficial similarity.